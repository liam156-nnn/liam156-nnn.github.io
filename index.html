<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>材料动态预警系统</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- 配置Tailwind自定义颜色 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            warning: '#FF7D00',
            danger: '#F53F3F',
            info: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .transition-bg {
        transition: background-color 0.3s ease;
      }
      .shadow-soft {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
    }
  </style>
  
  <style>
    /* 全局样式 */
    body {
      font-family: 'Inter', system-ui, sans-serif;
    }
    
    /* 表格行动画 */
    .table-row {
      transition: all 0.2s ease;
    }
    
    .table-row:hover {
      transform: translateY(-2px);
    }
    
    /* 预警状态样式 */
    .status-normal {
      background-color: rgba(54, 207, 201, 0.1);
    }
    
    .status-secondary {
      background-color: rgba(22, 93, 255, 0.1);
    }
    
    .status-primary {
      background-color: rgba(255, 125, 0, 0.1);
    }
    
    .status-expired {
      background-color: rgba(245, 63, 63, 0.1);
    }
    
    /* 平滑滚动 */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body class="bg-gray-50 text-dark">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-cubes text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-primary">材料动态预警系统</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="today-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all shadow-sm">
          <i class="fa fa-calendar mr-1"></i> 今日
        </button>
        <span id="current-date" class="text-info hidden md:inline-block"></span>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- 统计卡片区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-soft flex items-center">
        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-4">
          <i class="fa fa-list-alt text-xl"></i>
        </div>
        <div>
          <p class="text-info text-sm">总材料数</p>
          <p id="total-count" class="text-2xl font-bold">0</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-5 shadow-soft flex items-center">
        <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning mr-4">
          <i class="fa fa-exclamation-triangle text-xl"></i>
        </div>
        <div>
          <p class="text-info text-sm">一级预警</p>
          <p id="primary-alert-count" class="text-2xl font-bold">0</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-5 shadow-soft flex items-center">
        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-4">
          <i class="fa fa-info-circle text-xl"></i>
        </div>
        <div>
          <p class="text-info text-sm">二级预警</p>
          <p id="secondary-alert-count" class="text-2xl font-bold">0</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-5 shadow-soft flex items-center">
        <div class="w-12 h-12 rounded-full bg-danger/10 flex items-center justify-center text-danger mr-4">
          <i class="fa fa-times-circle text-xl"></i>
        </div>
        <div>
          <p class="text-info text-sm">已过期</p>
          <p id="expired-count" class="text-2xl font-bold">0</p>
        </div>
      </div>
    </div>
    
    <!-- 功能标签页 -->
    <div class="mb-6 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px" id="tabList" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="inline-block p-4 border-b-2 border-primary text-primary rounded-t-lg font-medium" 
                  id="monitor-tab" data-tab="monitor" type="button" role="tab">
            <i class="fa fa-dashboard mr-1"></i> 材料监控
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="inline-block p-4 border-b-2 border-transparent hover:text-primary hover:border-primary/30 rounded-t-lg font-medium text-info" 
                  id="history-tab" data-tab="history" type="button" role="tab">
            <i class="fa fa-history mr-1"></i> 检定历史
          </button>
        </li>
      </ul>
    </div>
    
    <!-- 材料监控表格区域 -->
    <div id="monitor-panel" class="tab-panel">
      <!-- 操作按钮区 -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <div class="relative w-full sm:w-64">
          <input type="text" id="search-input" placeholder="搜索材料名称..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
          <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <div class="flex space-x-3 w-full sm:w-auto justify-start sm:justify-end">
          <button id="filter-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all flex items-center">
            <i class="fa fa-filter mr-1"></i> 筛选
          </button>
          <button id="add-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center">
            <i class="fa fa-plus mr-1"></i> 添加材料
          </button>
        </div>
      </div>
      
      <!-- 表格容器 -->
      <div class="bg-white rounded-xl shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50 border-b border-gray-200">
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">材料名称</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">前次检定时间</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">检定周期(天)</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">下次检定时间</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">剩余天数</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">储存位置</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody id="materials-table-body">
              <!-- 表格内容将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 空状态 -->
        <div id="empty-state" class="py-16 text-center hidden">
          <i class="fa fa-box-open text-5xl text-gray-300 mb-4"></i>
          <p class="text-gray-500">暂无材料数据，请添加材料</p>
        </div>
      </div>
    </div>
    
    <!-- 检定历史表格区域 -->
    <div id="history-panel" class="tab-panel hidden">
      <!-- 操作区 -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <div class="relative w-full sm:w-64">
          <input type="text" id="history-search" placeholder="搜索材料名称..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
          <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <div class="w-full sm:w-auto text-right">
          <select id="history-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
            <option value="all">所有材料</option>
            <!-- 选项将通过JavaScript动态生成 -->
          </select>
        </div>
      </div>
      
      <!-- 历史表格 -->
      <div class="bg-white rounded-xl shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50 border-b border-gray-200">
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">材料名称</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">检定时间</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">检定人员</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">检定结果</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-info uppercase tracking-wider">备注</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <!-- 表格内容将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 历史空状态 -->
        <div id="history-empty" class="py-16 text-center hidden">
          <i class="fa fa-history text-5xl text-gray-300 mb-4"></i>
          <p class="text-gray-500">暂无检定历史记录</p>
        </div>
      </div>
    </div>
  </main>
  
  <!-- 添加/编辑材料模态框 -->
  <div id="material-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-xl font-bold">添加材料</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="material-form">
        <input type="hidden" id="material-id">
        
        <div class="mb-4">
          <label for="material-name" class="block text-sm font-medium text-gray-700 mb-1">材料名称 <span class="text-danger">*</span></label>
          <input type="text" id="material-name" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mb-4">
          <label for="last-inspection" class="block text-sm font-medium text-gray-700 mb-1">前次检定时间 <span class="text-danger">*</span></label>
          <input type="date" id="last-inspection" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mb-4">
          <label for="inspection-cycle" class="block text-sm font-medium text-gray-700 mb-1">检定周期(天) <span class="text-danger">*</span></label>
          <input type="number" id="inspection-cycle" min="1" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mb-4">
          <label for="storage-location" class="block text-sm font-medium text-gray-700 mb-1">储存位置 <span class="text-danger">*</span></label>
          <input type="text" id="storage-location" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" id="cancel-modal" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">取消</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">保存</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 记录检定结果模态框 -->
  <div id="inspection-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="inspection-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">记录检定结果</h3>
        <button id="close-inspection-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="inspection-form">
        <input type="hidden" id="inspection-material-id">
        
        <div class="mb-4">
          <label for="inspection-date" class="block text-sm font-medium text-gray-700 mb-1">本次检定时间 <span class="text-danger">*</span></label>
          <input type="date" id="inspection-date" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mb-4">
          <label for="inspector" class="block text-sm font-medium text-gray-700 mb-1">检定人员 <span class="text-danger">*</span></label>
          <input type="text" id="inspector" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
        </div>
        
        <div class="mb-4">
          <label for="inspection-result" class="block text-sm font-medium text-gray-700 mb-1">检定结果 <span class="text-danger">*</span></label>
          <select id="inspection-result" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
            <option value="合格">合格</option>
            <option value="不合格">不合格</option>
            <option value="待维修">待维修</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label for="inspection-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
          <textarea id="inspection-notes" rows="3"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"></textarea>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" id="cancel-inspection-modal" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">取消</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">记录</button>
        </div>
      </form>
    </div>
  </div>
  
  <footer class="bg-white border-t border-gray-200 py-6 mt-8">
    <div class="container mx-auto px-4 text-center text-info text-sm">
      <p>材料动态预警系统 &copy; <span id="current-year"></span></p>
    </div>
  </footer>

  <script>
    // 全局数据存储
    let materials = JSON.parse(localStorage.getItem('materials')) || [];
    let inspectionHistory = JSON.parse(localStorage.getItem('inspectionHistory')) || [];
    
    // DOM元素
    const materialsTableBody = document.getElementById('materials-table-body');
    const historyTableBody = document.getElementById('history-table-body');
    const historyFilter = document.getElementById('history-filter');
    const emptyState = document.getElementById('empty-state');
    const historyEmpty = document.getElementById('history-empty');
    const currentDateEl = document.getElementById('current-date');
    const currentYearEl = document.getElementById('current-year');
    const totalCountEl = document.getElementById('total-count');
    const primaryAlertCountEl = document.getElementById('primary-alert-count');
    const secondaryAlertCountEl = document.getElementById('secondary-alert-count');
    const expiredCountEl = document.getElementById('expired-count');
    const searchInput = document.getElementById('search-input');
    const historySearch = document.getElementById('history-search');
    const tabList = document.getElementById('tabList');
    
    // 模态框相关元素
    const materialModal = document.getElementById('material-modal');
    const modalContent = document.getElementById('modal-content');
    const inspectionModal = document.getElementById('inspection-modal');
    const inspectionModalContent = document.getElementById('inspection-modal-content');
    const materialForm = document.getElementById('material-form');
    const inspectionForm = document.getElementById('inspection-form');
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 设置当前日期和年份
      const now = new Date();
      currentDateEl.textContent = formatDate(now);
      currentYearEl.textContent = now.getFullYear();
      
      // 设置默认日期为今天
      document.getElementById('last-inspection').valueAsDate = now;
      document.getElementById('inspection-date').valueAsDate = now;
      
      // 渲染数据
      renderMaterials();
      renderHistory();
      updateCounters();
      updateHistoryFilter();
      
      // 绑定事件
      bindEvents();
    });
    
    // 事件绑定
    function bindEvents() {
      // 标签页切换
      tabList.addEventListener('click', (e) => {
        if (e.target.hasAttribute('data-tab')) {
          const tab = e.target.getAttribute('data-tab');
          switchTab(tab);
        }
      });
      
      // 添加材料按钮
      document.getElementById('add-btn').addEventListener('click', openAddModal);
      
      // 关闭模态框
      document.getElementById('close-modal').addEventListener('click', closeModal);
      document.getElementById('cancel-modal').addEventListener('click', closeModal);
      
      // 关闭检定记录模态框
      document.getElementById('close-inspection-modal').addEventListener('click', closeInspectionModal);
      document.getElementById('cancel-inspection-modal').addEventListener('click', closeInspectionModal);
      
      // 表单提交
      materialForm.addEventListener('submit', handleMaterialFormSubmit);
      inspectionForm.addEventListener('submit', handleInspectionFormSubmit);
      
      // 搜索功能
      searchInput.addEventListener('input', renderMaterials);
      historySearch.addEventListener('input', renderHistory);
      
      // 历史筛选
      historyFilter.addEventListener('change', renderHistory);
      
      // 今日按钮
      document.getElementById('today-btn').addEventListener('click', () => {
        const today = new Date();
        const todayStr = formatDateForInput(today);
        
        // 高亮显示今天需要检定的材料
        document.querySelectorAll('.table-row').forEach(row => {
          const nextDateEl = row.querySelector('[data-next-date]');
          if (nextDateEl && nextDateEl.getAttribute('data-next-date') === todayStr) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('ring-2', 'ring-primary');
            setTimeout(() => {
              row.classList.remove('ring-2', 'ring-primary');
            }, 2000);
          }
        });
      });
    }
    
    // 切换标签页
    function switchTab(tabName) {
      // 更新标签样式
      document.querySelectorAll('[data-tab]').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('border-primary', 'text-primary');
          tab.classList.remove('border-transparent', 'text-info', 'hover:border-primary/30');
        } else {
          tab.classList.add('border-transparent', 'text-info', 'hover:border-primary/30');
          tab.classList.remove('border-primary', 'text-primary');
        }
      });
      
      // 显示对应面板
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(`${tabName}-panel`).classList.remove('hidden');
    }
    
    // 渲染材料表格
    function renderMaterials() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      let filteredMaterials = materials;
      
      // 搜索过滤
      if (searchTerm) {
        filteredMaterials = materials.filter(material => 
          material.name.toLowerCase().includes(searchTerm)
        );
      }
      
      // 按剩余天数排序（近的在前）
      filteredMaterials.sort((a, b) => calculateDaysLeft(a) - calculateDaysLeft(b));
      
      // 清空表格
      materialsTableBody.innerHTML = '';
      
      // 检查是否为空
      if (filteredMaterials.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      // 添加材料行
      filteredMaterials.forEach(material => {
        const daysLeft = calculateDaysLeft(material);
        const nextInspectionDate = calculateNextInspectionDate(material);
        
        // 确定预警状态
        let statusClass = 'status-normal';
        if (daysLeft < 0) {
          statusClass = 'status-expired';
        } else if (daysLeft <= 15) {
          statusClass = 'status-primary';
        } else if (daysLeft <= 30) {
          statusClass = 'status-secondary';
        }
        
        // 创建行
        const row = document.createElement('tr');
        row.className = `table-row border-b border-gray-200 ${statusClass}`;
        row.setAttribute('data-id', material.id);
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium">${material.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">${formatDateFromInput(material.lastInspection)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${material.cycle}</td>
          <td class="px-6 py-4 whitespace-nowrap" data-next-date="${nextInspectionDate}">
            ${formatDateFromInput(nextInspectionDate)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
              ${daysLeft < 0 ? 'bg-danger/20 text-danger' : 
                daysLeft <= 15 ? 'bg-warning/20 text-warning' : 
                daysLeft <= 30 ? 'bg-primary/20 text-primary' : 
                'bg-secondary/20 text-secondary'}">
              ${daysLeft < 0 ? `已过期 ${Math.abs(daysLeft)} 天` : `${daysLeft} 天`}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">${material.location}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button class="text-primary hover:text-primary/80 edit-btn" data-id="${material.id}">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="text-secondary hover:text-secondary/80 inspect-btn" data-id="${material.id}">
                <i class="fa fa-check-square-o"></i>
              </button>
              <button class="text-danger hover:text-danger/80 delete-btn" data-id="${material.id}">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        materialsTableBody.appendChild(row);
      });
      
      // 绑定行内按钮事件
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          openEditModal(id);
        });
      });
      
      document.querySelectorAll('.inspect-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          openInspectionModal(id);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          deleteMaterial(id);
        });
      });
    }
    
    // 渲染历史记录
    function renderHistory() {
      const searchTerm = historySearch.value.toLowerCase().trim();
      const filterValue = historyFilter.value;
      
      // 筛选历史记录
      let filteredHistory = inspectionHistory;
      
      if (filterValue !== 'all') {
        filteredHistory = filteredHistory.filter(item => item.materialId === filterValue);
      }
      
      if (searchTerm) {
        // 获取材料ID到名称的映射
        const materialMap = {};
        materials.forEach(m => {
          materialMap[m.id] = m.name;
        });
        
        filteredHistory = filteredHistory.filter(item => {
          const materialName = materialMap[item.materialId] || '';
          return materialName.toLowerCase().includes(searchTerm);
        });
      }
      
      // 按时间排序（新的在前）
      filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // 清空表格
      historyTableBody.innerHTML = '';
      
      // 检查是否为空
      if (filteredHistory.length === 0) {
        historyEmpty.classList.remove('hidden');
        return;
      }
      
      historyEmpty.classList.add('hidden');
      
      // 添加历史记录行
      filteredHistory.forEach(record => {
        const material = materials.find(m => m.id === record.materialId);
        const materialName = material ? material.name : '未知材料';
        
        const row = document.createElement('tr');
        row.className = 'table-row border-b border-gray-200';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">${materialName}</td>
          <td class="px-6 py-4 whitespace-nowrap">${formatDateFromInput(record.date)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${record.inspector}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
              ${record.result === '合格' ? 'bg-secondary/20 text-secondary' : 
                record.result === '不合格' ? 'bg-danger/20 text-danger' : 
                'bg-warning/20 text-warning'}">
              ${record.result}
            </span>
          </td>
          <td class="px-6 py-4">${record.notes || '-'}</td>
        `;
        
        historyTableBody.appendChild(row);
      });
    }
    
    // 更新计数器
    function updateCounters() {
      let primaryAlertCount = 0;
      let secondaryAlertCount = 0;
      let expiredCount = 0;
      
      materials.forEach(material => {
        const daysLeft = calculateDaysLeft(material);
        
        if (daysLeft < 0) {
          expiredCount++;
        } else if (daysLeft <= 15) {
          primaryAlertCount++;
        } else if (daysLeft <= 30) {
          secondaryAlertCount++;
        }
      });
      
      totalCountEl.textContent = materials.length;
      primaryAlertCountEl.textContent = primaryAlertCount;
      secondaryAlertCountEl.textContent = secondaryAlertCount;
      expiredCountEl.textContent = expiredCount;
    }
    
    // 更新历史筛选下拉框
    function updateHistoryFilter() {
      // 保存当前选中值
      const currentValue = historyFilter.value;
      
      // 保留"所有材料"选项，清除其他选项
      while (historyFilter.options.length > 1) {
        historyFilter.remove(1);
      }
      
      // 添加材料选项
      materials.forEach(material => {
        const option = document.createElement('option');
        option.value = material.id;
        option.textContent = material.name;
        historyFilter.appendChild(option);
      });
      
      // 恢复选中值或设置为"所有材料"
      if (currentValue && (currentValue === 'all' || materials.some(m => m.id === currentValue))) {
        historyFilter.value = currentValue;
      } else {
        historyFilter.value = 'all';
      }
    }
    
    // 计算下次检定日期
    function calculateNextInspectionDate(material) {
      const lastDate = new Date(material.lastInspection);
      const nextDate = new Date(lastDate);
      nextDate.setDate(lastDate.getDate() + parseInt(material.cycle));
      return formatDateForInput(nextDate);
    }
    
    // 计算剩余天数
    function calculateDaysLeft(material) {
      const nextDate = new Date(calculateNextInspectionDate(material));
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const diffTime = nextDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }
    
    // 打开添加材料模态框
    function openAddModal() {
      document.getElementById('modal-title').textContent = '添加材料';
      document.getElementById('material-id').value = '';
      materialForm.reset();
      
      // 设置默认日期为今天
      document.getElementById('last-inspection').valueAsDate = new Date();
      
      openModal();
    }
    
    // 打开编辑材料模态框
    function openEditModal(id) {
      const material = materials.find(m => m.id === id);
      if (!material) return;
      
      document.getElementById('modal-title').textContent = '编辑材料';
      document.getElementById('material-id').value = material.id;
      document.getElementById('material-name').value = material.name;
      document.getElementById('last-inspection').value = material.lastInspection;
      document.getElementById('inspection-cycle').value = material.cycle;
      document.getElementById('storage-location').value = material.location;
      
      openModal();
    }
    
    // 打开模态框
    function openModal() {
      materialModal.classList.remove('hidden');
      // 触发动画
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-300');
      }, 10);
    }
    
    // 关闭模态框
    function closeModal() {
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
      
      setTimeout(() => {
        materialModal.classList.add('hidden');
      }, 300);
    }
    
    // 打开检定记录模态框
    function openInspectionModal(id) {
      const material = materials.find(m => m.id === id);
      if (!material) return;
      
      document.getElementById('inspection-material-id').value = material.id;
      document.getElementById('inspection-date').valueAsDate = new Date();
      document.getElementById('inspector').value = '';
      document.getElementById('inspection-result').value = '合格';
      document.getElementById('inspection-notes').value = '';
      
      inspectionModal.classList.remove('hidden');
      // 触发动画
      setTimeout(() => {
        inspectionModalContent.classList.remove('scale-95', 'opacity-0');
        inspectionModalContent.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-300');
      }, 10);
    }
    
    // 关闭检定记录模态框
    function closeInspectionModal() {
      inspectionModalContent.classList.remove('scale-100', 'opacity-100');
      inspectionModalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
      
      setTimeout(() => {
        inspectionModal.classList.add('hidden');
      }, 300);
    }
    
    // 处理材料表单提交
    function handleMaterialFormSubmit(e) {
      e.preventDefault();
      
      const id = document.getElementById('material-id').value;
      const name = document.getElementById('material-name').value;
      const lastInspection = document.getElementById('last-inspection').value;
      const cycle = document.getElementById('inspection-cycle').value;
      const location = document.getElementById('storage-location').value;
      
      if (id) {
        // 更新现有材料
        const index = materials.findIndex(m => m.id === id);
        if (index !== -1) {
          materials[index] = {
            ...materials[index],
            name,
            lastInspection,
            cycle,
            location
          };
        }
      } else {
        // 添加新材料
        materials.push({
          id: generateId(),
          name,
          lastInspection,
          cycle,
          location
        });
      }
      
      // 保存数据
      saveMaterials();
      
      // 关闭模态框
      closeModal();
      
      // 重新渲染
      renderMaterials();
      updateCounters();
      updateHistoryFilter();
    }
    
    // 处理检定表单提交
    function handleInspectionFormSubmit(e) {
      e.preventDefault();
      
      const materialId = document.getElementById('inspection-material-id').value;
      const date = document.getElementById('inspection-date').value;
      const inspector = document.getElementById('inspector').value;
      const result = document.getElementById('inspection-result').value;
      const notes = document.getElementById('inspection-notes').value;
      
      // 记录检定历史
      inspectionHistory.push({
        id: generateId(),
        materialId,
        date,
        inspector,
        result,
        notes
      });
      
      // 更新材料的上次检定时间
      const materialIndex = materials.findIndex(m => m.id === materialId);
      if (materialIndex !== -1) {
        materials[materialIndex].lastInspection = date;
      }
      
      // 保存数据
      saveMaterials();
      saveInspectionHistory();
      
      // 关闭模态框
      closeInspectionModal();
      
      // 重新渲染
      renderMaterials();
      renderHistory();
      updateCounters();
    }
    
    // 删除材料
    function deleteMaterial(id) {
      if (confirm('确定要删除这个材料吗？相关的检定历史也会被删除。')) {
        // 删除材料
        materials = materials.filter(m => m.id !== id);
        
        // 删除相关的历史记录
        inspectionHistory = inspectionHistory.filter(h => h.materialId !== id);
        
        // 保存数据
        saveMaterials();
        saveInspectionHistory();
        
        // 重新渲染
        renderMaterials();
        renderHistory();
        updateCounters();
        updateHistoryFilter();
      }
    }
    
    // 保存材料数据到本地存储
    function saveMaterials() {
      localStorage.setItem('materials', JSON.stringify(materials));
    }
    
    // 保存检定历史到本地存储
    function saveInspectionHistory() {
      localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
    }
    
    // 生成唯一ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // 格式化日期为显示格式
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // 格式化日期为输入框格式
    function formatDateForInput(date) {
      return formatDate(date);
    }
    
    // 从输入框格式转换为显示格式（带年月日）
    function formatDateFromInput(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${year}年${month}月${day}日`;
    }
  </script>
</body>
</html>
